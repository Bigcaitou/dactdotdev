<!doctype html><html class="h-full w-full font-sans" lang=zh-cn><head><meta charset=utf-8><link rel="shortcut icon" href=http://example.org/favicon.ico type=image/x-icon><meta name=viewport content="width=device-width,initial-scale=1"><title>- My New Hugo Site</title><meta property="og:title" content><meta property="og:description" content="[TOC]
PonyORM生成SQL原理 详见《How Pony ORM translates Python generators to SQL queries》
AST  在计算机科学中，抽象语法树（Abstract Syntax Tree，AST），或简称语法树（Syntax tree），是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。之所以说语法是“抽象”的，是因为这里的语法并不会表示出真实语法中出现的每个细节。比如，嵌套括号被隐含在树的结构中，并没有以节点的形式呈现；而类似于 if-condition-then 这样的条件跳转语句，可以使用带有两个分支的节点来表示。
 后续遍历二叉树 Python generator to SQL translation  Decompile bytecode and restore AST Translate AST to ‘abstract SQL’ Translate ‘abstract SQL’ to a specific SQL dialect  踩坑记录 service match_name的查询方法改成filter的形式
service in services的形式 services是在BaseControl里的根据project筛选的
items = select( item for item in self.model if item.project == project ) 然后再用select 相当于会有两个sql语句 而且是in services的形式 sql非常非常长 !"><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/python/ponyorm_implement/"><meta property="article:section" content="python"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="[TOC]
PonyORM生成SQL原理 详见《How Pony ORM translates Python generators to SQL queries》
AST  在计算机科学中，抽象语法树（Abstract Syntax Tree，AST），或简称语法树（Syntax tree），是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。之所以说语法是“抽象”的，是因为这里的语法并不会表示出真实语法中出现的每个细节。比如，嵌套括号被隐含在树的结构中，并没有以节点的形式呈现；而类似于 if-condition-then 这样的条件跳转语句，可以使用带有两个分支的节点来表示。
 后续遍历二叉树 Python generator to SQL translation  Decompile bytecode and restore AST Translate AST to ‘abstract SQL’ Translate ‘abstract SQL’ to a specific SQL dialect  踩坑记录 service match_name的查询方法改成filter的形式
service in services的形式 services是在BaseControl里的根据project筛选的
items = select( item for item in self.model if item.project == project ) 然后再用select 相当于会有两个sql语句 而且是in services的形式 sql非常非常长 !"><link rel=stylesheet href=/css/styles.pcss integrity=><script>localStorage.theme==='dark'||!('theme'in localStorage)&&window.matchMedia('(prefers-color-scheme: dark)').matches?document.documentElement.classList.add('dark'):document.documentElement.classList.remove('dark')</script></head><body class="flex flex-col items-center w-full"><main class="w-full sm:w-10/12 md:w-9/12 lg:w-7/12 xl:w-5/12 m-auto px-6"><header class="mt-9 mb-8"><div class="flex justify-between items-center"><div class="flex items-center"><input id=navbar_btn class=hidden type=checkbox>
<label for=navbar_btn class="menu-btn mr-4 items-center flex xl:hidden"><span class=navicon></span></label><a href=/ class="font-bold text-lg xl:text-2xl mr-auto">My New Hugo Site</a></div><div class="flex items-center"><div class="cursor-pointer ml-2"><svg id="dark_mode_btn" class="hidden" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 15.31 23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69zM12 18c-3.31.0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg></svg><svg id="light_mode_btn" class="hidden" width="18" height="18" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><g><path d="M0 0h24v24H0V0z" fill="none"/></g><g><g><g><path d="M14 2c1.82.0 3.53.5 5 1.35C16.01 5.08 14 8.3 14 12s2.01 6.92 5 8.65C17.53 21.5 15.82 22 14 22 8.48 22 4 17.52 4 12S8.48 2 14 2z"/></g></g></g></svg></svg></div></div></div><nav id=navbar class="mt-3 hidden xl:block"><ul class=flex></ul></nav><nav id=navbar_sm class="mt-2 hidden"><ul></ul><hr class=my-4></nav></header><div id=content class=my-8><div class="collapsible-menu-wrapper my-8 p-4 border-2 rounded"><div class="flex justify-between"><span class=font-bold>Table of contents</span></div><div class="collapsible-menu text-sm ml-2"><div class=leading-6><nav id=TableOfContents><ul><li><a href=#ponyorm生成sql原理>PonyORM生成SQL原理</a><ul><li><a href=#ast>AST</a></li><li><a href=#python-generator-to-sql-translation>Python generator to SQL translation</a></li><li><a href=#踩坑记录>踩坑记录</a></li></ul></li><li><a href=#属性常见标记>属性常见标记</a></li><li><a href=#代码案例>代码案例</a><ul><li><a href=#ponyorm-code>PonyORM code</a></li><li><a href=#mysql-code>MySQL code</a></li></ul></li><li><a href=#多表关联>多表关联</a><ul><li><a href=#cascade_delete关联删除>cascade_delete关联删除</a></li><li><a href=#关联关系表>关联关系表</a></li><li><a href=#采坑记录>采坑记录</a></li><li><a href=#inner-join和left-join>inner join和left join</a></li></ul></li></ul></nav></div></div></div><div class=my-7><article><p>[TOC]</p><h2 id=ponyorm生成sql原理>PonyORM生成SQL原理</h2><p>详见《<a href=https://www.slideshare.net/ponyorm/pony-orm-ep2014-slideshare>How Pony ORM translates Python generators to SQL queries</a>》</p><h3 id=ast>AST</h3><blockquote><p>在计算机科学中，抽象语法树（Abstract Syntax Tree，AST），或简称语法树（Syntax tree），是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。之所以说语法是“抽象”的，是因为这里的语法并不会表示出真实语法中出现的每个细节。比如，嵌套括号被隐含在树的结构中，并没有以节点的形式呈现；而类似于 if-condition-then 这样的条件跳转语句，可以使用带有两个分支的节点来表示。</p></blockquote><p><img src=images/20181017111303.png alt></p><h4 id=后续遍历二叉树>后续遍历二叉树</h4><h3 id=python-generator-to-sql-translation>Python generator to SQL translation</h3><ol><li>Decompile bytecode and restore AST</li><li>Translate AST to ‘abstract SQL’</li><li>Translate ‘abstract SQL’ to a specific SQL dialect</li></ol><h3 id=踩坑记录>踩坑记录</h3><p>service match_name的查询方法改成filter的形式</p><p><img src=images/20181017111731.png alt></p><p>service in services的形式 services是在BaseControl里的根据project筛选的</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>items <span style=color:#f92672>=</span> select(
    item 
    <span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>model 
    <span style=color:#66d9ef>if</span> item<span style=color:#f92672>.</span>project <span style=color:#f92672>==</span> project
)
</code></pre></div><p>然后再用select 相当于会有两个sql语句 而且是in services的形式 sql非常非常长 !</p><p><img src=images/20181017111739.png alt=20181017111739></p><p>换成filter以后相当于最后才组装sql 把之前对project筛选也加进去 sql比较简洁 !</p><p><img src=images/20181017111744.png alt=20181017111744></p><h2 id=属性常见标记>属性常见标记</h2><ul><li>required</li><li>optional</li><li>primary</li></ul><blockquote><p>Required and Optional Usually most entity attributes are of Required or Optional kind. If an attribute is defined as Required then it must have a value at all times, while Optional attributes can be empty. If you need the value of an attribute to be unique then you can set the attribute option unique=True.</p></blockquote><p><img src=images/20181017111058.png alt=20181017111058></p><h2 id=代码案例>代码案例</h2><h3 id=ponyorm-code>PonyORM code</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainTable</span>(db<span style=color:#f92672>.</span>Entity):id <span style=color:#f92672>=</span> Required(int)
    optional_attr <span style=color:#f92672>=</span> Optional(str)
    required_attr <span style=color:#f92672>=</span> Required(str)
    primary_attr <span style=color:#f92672>=</span> Required(str)
    unique_attr <span style=color:#f92672>=</span> Optional(Decimal, unique<span style=color:#f92672>=</span>True)
    nullable_attr <span style=color:#f92672>=</span> Optional(date, nullable<span style=color:#f92672>=</span>True)
    one_to_one_table <span style=color:#f92672>=</span> Required(<span style=color:#e6db74>&#39;OneToOneTable&#39;</span>)
    one_to_many_table <span style=color:#f92672>=</span> Required(<span style=color:#e6db74>&#39;OneToManyTable&#39;</span>)     
    many_to_one_tables <span style=color:#f92672>=</span> Set(<span style=color:#e6db74>&#39;ManyToOneTable&#39;</span>)
    many_to_many_tables <span style=color:#f92672>=</span> Set(<span style=color:#e6db74>&#39;ManyToManyTable&#39;</span>)
    PrimaryKey(id, primary_attr)
    
</code></pre></div><h3 id=mysql-code>MySQL code</h3><p>MySQL生成的sql，注意optional_attr也是 <code>NOT NULL</code>，因为MySQL中的<code>NULL</code> 和 <code>空值</code> 不是一个概念，最好在Requied</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>maintable<span style=color:#f92672>`</span> (
    <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> INTEGER <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,   
    <span style=color:#f92672>`</span>optional_attr<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,   
    <span style=color:#f92672>`</span>required_attr<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,   
    <span style=color:#f92672>`</span>primary_attr<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,   
    <span style=color:#f92672>`</span>unique_attr<span style=color:#f92672>`</span> DECIMAL(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>UNIQUE</span>,   
    <span style=color:#f92672>`</span>nullable_attr<span style=color:#f92672>`</span> DATE,   
    <span style=color:#f92672>`</span>one_to_one_table<span style=color:#f92672>`</span> INTEGER <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,   
    <span style=color:#f92672>`</span>one_to_many_table<span style=color:#f92672>`</span> INTEGER <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,   
    <span style=color:#66d9ef>CONSTRAINT</span> <span style=color:#f92672>`</span>pk_maintable<span style=color:#f92672>`</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>primary_attr<span style=color:#f92672>`</span>) 
);
</code></pre></div><h2 id=多表关联>多表关联</h2><p><img src=images/20181017110420.png alt=20181017110420></p><h3 id=cascade_delete关联删除>cascade_delete关联删除</h3><p>当PonyORM删除实体(entity)的实例(instance)的时候，它还需要删除与其他对象(object)的关系。两个对象之间的关系由两个关系属性定义的。</p><ul><li>如果关系的另一侧被声明为 <code>Set</code> ，则只需要从该集合中删除该对象；</li><li>多对一，删除该实例 * 多对多，删除中间表</li><li>如果另一边被声明为 <code>Optional</code> ，则只需把它设置为None；</li><li>如果另一边被声明为 <code>Required</code>，不能为该关系属性指定None</li></ul><p>可以使用属性的 <code>cascade_delete</code> 选项更改此默认行为。默认情况下，当关系的另一侧声明为Required时，此选项设置为True，对于所有其他关系类型，此选项设置为False。</p><ul><li>True 意味着 Pony 总是做关联删除，即时另一边定义的是 Optional。</li><li>False 意味着 Pony 总是不对这个关系做关联删除。</li></ul><h3 id=关联关系表>关联关系表</h3><table><thead><tr><th>cascade_delete</th><th>A和B的关系</th><th>B在A中的声明</th><th>A在B中的声明</th><th>操作</th><th>说明</th></tr></thead><tbody><tr><td>False</td><td>所有关系</td><td>所有类型</td><td>Require</td><td>删除A</td><td>因为B的声明中A是Require必须的，如果A被删除且B有记录，则会报错（raises the ConstraintError）</td></tr><tr><td>True</td><td>一对一</td><td></td><td></td><td>删除A</td><td>B也会删除</td></tr><tr><td>True</td><td>一对多</td><td>Set</td><td>Optional</td><td></td><td></td></tr><tr><td>True</td><td>一对多</td><td>Set</td><td>Required</td><td></td><td></td></tr><tr><td>True</td><td>多对一</td><td>Optional</td><td>Set</td><td></td><td></td></tr><tr><td>True</td><td>多对一</td><td>Required</td><td>Set</td><td></td><td></td></tr><tr><td>True</td><td>多对一</td><td>Set</td><td>Set</td><td></td><td>TypeError: &lsquo;cascade_delete&rsquo; option cannot be set for attribute Crontab.requestlog, because reverse attribute RequestLog.crontab is collection</td></tr></tbody></table><h4 id=案例>案例</h4><p>如果在另一端将关系定义为Required并且cascade_delete = False，则Pony会在删除尝试时引发ConstraintError异常，例如删除Services关联着Domain表，因为Domain表有外键依赖于Service，所以如果不把Domain关联联删除，删除Service时会报错。</p><h3 id=采坑记录>采坑记录</h3><p><a href=https://stackoverflow.com/questions/44060834/how-to-use-a-sql-view-with-pony-orm%22>How to use a SQL View with Pony ORM</a></p><h3 id=inner-join和left-join>inner join和left join</h3><p><a href=https://stackoverflow.com/questions/41847908/pony-orm-join-syntax>Pony ORM JOIN syntax</a></p><h4 id=raw-sql>raw sql</h4><p>You can write raw SQL query without defining any entity:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>with</span> db_session:
    start_date <span style=color:#f92672>=</span> date(<span style=color:#ae81ff>2017</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>)
    rows <span style=color:#f92672>=</span> db<span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>        SELECT `Date` AS dt, `Aluminum Count` AS ac, `PET Count` AS pc         
</span><span style=color:#e6db74>        FROM `ResidueCountByDate`
</span><span style=color:#e6db74>        WHERE `Date` &gt;= $start_date
</span><span style=color:#e6db74>    &#39;&#39;&#39;</span>)
    <span style=color:#66d9ef>for</span> row <span style=color:#f92672>in</span> rows:
        <span style=color:#66d9ef>print</span>(row[<span style=color:#ae81ff>0</span>], row[<span style=color:#ae81ff>1</span>], row[<span style=color:#ae81ff>2</span>])
        <span style=color:#66d9ef>print</span>(row<span style=color:#f92672>.</span>dt, row<span style=color:#f92672>.</span>ac, row<span style=color:#f92672>.</span>pc)  <span style=color:#75715e># the same as previous row </span>
</code></pre></div><h4 id=new-entity>new entity</h4><p>Define a new entity and specify the view name as a table name for that entity:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResidueCountByDate</span>(db<span style=color:#f92672>.</span>Entity):
    dt <span style=color:#f92672>=</span> PrimaryKey(date, column<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Date&#39;</span>)
    aluminum_count <span style=color:#f92672>=</span> Required(int, column<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Aluminum Count&#39;</span>)     
    pet_count <span style=color:#f92672>=</span> Required(int, column<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;PET Count&#39;</span>)
</code></pre></div><p>After that you can use that entity to select data from the view:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>with</span> db_session:
    start_date <span style=color:#f92672>=</span> date(<span style=color:#ae81ff>2017</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>)
    query <span style=color:#f92672>=</span> select(
        rc <span style=color:#66d9ef>for</span> rc <span style=color:#f92672>in</span> ResidueCountByDate 
        <span style=color:#66d9ef>if</span> rc<span style=color:#f92672>.</span>date <span style=color:#f92672>&gt;=</span> start_date)
    <span style=color:#66d9ef>for</span> rc <span style=color:#f92672>in</span> query:
        <span style=color:#66d9ef>print</span>(rc<span style=color:#f92672>.</span>date, rc<span style=color:#f92672>.</span>aluminum_count, rc<span style=color:#f92672>.</span>pet_count)
</code></pre></div><p>By default, a column name is equal to an attribute name. I explicitly specified column for each attribute, because in Python attribute names cannot contain spaces, and usually written in lowercase. It is possible to explicitly specify table name if it is not equal to entity name:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResidueCount</span>(db<span style=color:#f92672>.</span>Entity):
    _table_ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ResidueCountByDate&#39;</span>
</code></pre></div></article></div></div></main><script src=/js/header.0b11855b871cb4d10c6c07b6723b9209f5c2bc9100735ab6ff47c8f9b76bb3d6ae41b488083b5fb15697987334039eb651b25c83228c29ac48a2bc168db8a894.js integrity="sha512-CxGFW4cctNEMbAe2cjuSCfXCvJEAc1q2/0fI+bdrs9auQbSICDtfsVaXmHM0A562UbJcgyKMKaxIorwWjbiolA=="></script><script src=/js/zooming.js integrity></script><script src=/js/code-copy-btn.js integrity></script></body></html>